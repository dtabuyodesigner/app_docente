<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Alumnos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #003366;
            --secondary: #007bff;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --bg: #f0f2f5;
            --text: #333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Nav */
        .nav {
            background: #003366;
            padding: 10px 15px;
            margin-bottom: 25px;
            border-radius: 12px;
            display: flex;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            align-items: center;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        .nav a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            padding: 8px 12px;
            font-size: 0.95rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid transparent;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .nav a:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav a.active {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        a {
            text-decoration: none;
            color: #333;
        }

        .volver {
            margin-bottom: 15px;
            display: inline-block;
            font-weight: bold;
        }

        .contenedor {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
        }

        /* ===== LISTADO ===== */

        .lista {
            background: white;
            border-radius: 12px;
            padding: 15px;
            height: calc(100vh - 180px);
            overflow-y: auto;
            box-shadow: var(--shadow);
            border: 1px solid #eef2f7;
        }

        .lista h3 {
            margin-top: 0;
        }

        .alumno-item {
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            color: #444;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alumno-item:hover {
            background: #f0f4f8;
            color: var(--primary);
        }

        .alumno-item.activo {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        /* ===== FICHA ===== */

        .ficha {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
        }

        .ficha h2 {
            margin-top: 0;
        }

        input,
        textarea {
            width: 100%;
            padding: 6px;
            margin-bottom: 10px;
        }

        textarea {
            height: 80px;
        }

        button {
            padding: 8px 14px;
            cursor: pointer;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow);
        }

        /* Mobile tweaks */
        @media (max-width: 768px) {
            .contenedor {
                grid-template-columns: 1fr;
            }

            .lista {
                height: 300px;
                margin-bottom: 20px;
            }

            .nav {
                justify-content: center;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/global_groups.js"></script>
</head>

<body>
    <div class="container">
        <div class="nav">
            <a href="/">üè† Inicio</a>
            <a href="/alumnos" class="active">üë• Alumnos</a>
            <a href="/asistencia">üìã Pasar lista</a>
            <a href="/comedor">üçΩÔ∏è Comedor</a>
            <a href="/diario">üìì Diario</a>
            <a href="/programacion">üìÖ Calendario</a>
            <a href="/horario">‚è∞ Horario</a>
            <a href="/evaluacion">üìä Evaluaci√≥n</a>
            <a href="/rubricas">üìù R√∫bricas</a>
            <a href="/informes">üìú Informes</a>
            <a href="/reuniones">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Reuniones</a>
        </div>

        <div
            style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <h2 style="margin:0;">üë¶ Alumnos</h2>
                <div
                    style="background: white; padding: 6px 12px; border-radius: 8px; border: 1px solid #ddd; display: flex; align-items: center; gap: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                    <span style="font-size: 1.1rem;">üìö</span>
                    <select id="globalGroupSelect" onchange="changeActiveGroup(this.value)"
                        style="border: none; background: transparent; font-weight: 600; font-size: 0.9rem; color: var(--primary); cursor: pointer; outline: none;">
                        <option value="">Cargando grupos...</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button class="nav-btn" onclick="mostrarModalNuevo()"
                    style="background:var(--primary); color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:600; cursor:pointer;">
                    ‚ûï Nuevo Alumno
                </button>
                <button onclick="descargarPlantilla()"
                    style="background:white; border:1px solid #ddd; padding:10px 15px; border-radius:8px; cursor:pointer;">
                    üìÑ Plantilla CSV
                </button>
                <button onclick="document.getElementById('csvInput').click()"
                    style="background:white; border:1px solid #ddd; padding:10px 15px; border-radius:8px; cursor:pointer;">
                    üì§ Importar CSV
                </button>
                <input type="file" id="csvInput" hidden accept=".csv" onchange="importarCSV(this)">

                <div style="flex-grow: 1;"></div>

                <button onclick="exportarData('json')"
                    style="background:#f8f9fa; border:1px solid #ddd; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">
                    üì• Exportar JSON
                </button>
                <button onclick="exportarData('csv')"
                    style="background:#f8f9fa; border:1px solid #ddd; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:0.85rem;">
                    üì• Exportar CSV
                </button>
            </div>
        </div>

        <div class="contenedor">

            <!-- LISTADO -->
            <div class="lista">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0;">Listado</h3>
                    <div style="display:flex; gap:5px;">
                        <button id="btnBatchTransfer" onclick="batchTransfer()"
                            style="display:none; padding:4px 8px; font-size:12px; background:var(--info); color:white; border:none; border-radius:4px;"
                            title="Transferir Seleccionados">üîÑ Transferir</button>
                        <button id="btnBatchDelete" onclick="batchDelete()"
                            style="display:none; padding:4px 8px; font-size:12px; background:var(--danger); color:white; border:none; border-radius:4px;"
                            title="Eliminar Seleccionados">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
                <div style="margin-bottom: 10px; padding: 0 12px; display:flex; align-items:center;">
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)"
                        style="margin-right:10px; width:auto; margin-bottom:0; transform: scale(1.2); cursor:pointer;">
                    <label for="selectAllCheckbox"
                        style="font-size:0.9rem; color:#666; cursor:pointer; margin-bottom:0;">Seleccionar todos</label>
                </div>
                <div id="listaAlumnos"></div>
            </div>

            <!-- FICHA -->
            <div class="ficha">
                <h2 id="nombreAlumno">Selecciona un alumno</h2>

                <!-- TABS SUPERIORES -->
                <div class="profile-tabs"
                    style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                    <button onclick="changeProfileTab('datos')" id="btnTabDatos"
                        style="background:none; border:none; border-bottom:3px solid #003366; padding:8px 15px; cursor:pointer; font-weight:bold; color: #003366;">üìÅ
                        Datos Personales</button>
                    <button onclick="changeProfileTab('progreso')" id="btnTabProgreso"
                        style="background:none; border:none; padding:8px 15px; cursor:pointer; font-weight:bold; color: #666;">üìà
                        Progreso Acad√©mico</button>
                </div>

                <!-- CONTENIDO: DATOS -->
                <div id="sectionDatos">
                    <label>Fecha nacimiento</label>
                    <input type="date" id="fecha_nacimiento">

                    <label>Direcci√≥n</label>
                    <input type="text" id="direccion">

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div>
                            <label>Madre (Nombre)</label>
                            <input type="text" id="madre_nombre">
                        </div>
                        <div>
                            <label>Tel√©fono Madre</label>
                            <input type="text" id="madre_telefono">
                        </div>
                        <div style="grid-column: span 2;">
                            <label>Email Madre</label>
                            <input type="email" id="madre_email">
                        </div>
                        <div>
                            <label>Padre (Nombre)</label>
                            <input type="text" id="padre_nombre">
                        </div>
                        <div>
                            <label>Tel√©fono Padre</label>
                            <input type="text" id="padre_telefono">
                        </div>
                        <div style="grid-column: span 2;">
                            <label>Email Padre</label>
                            <input type="email" id="padre_email">
                        </div>
                    </div>

                    <label>Observaciones generales</label>
                    <textarea id="observaciones_generales"></textarea>

                    <label>Personas Autorizadas</label>
                    <textarea id="personas_autorizadas" placeholder="Lista de personas autorizadas..."></textarea>

                    <div style="margin-top:15px; text-align:right;">
                        <button onclick="limpiarFicha()"
                            style="background:#ddd; border-radius: 4px; border: 1px solid #ccc;">
                            üßπ Limpiar ficha
                        </button>

                        <button onclick="guardarFicha()"
                            style="background:#2ecc71; color:white; border-radius: 4px; border: none; font-weight: bold;">
                            üíæ Guardar ficha
                        </button>
                    </div>
                    <div id="mensajeGuardado" style="margin-top:10px; color:#2ecc71; font-weight:bold; display:none;">
                        ‚úî Ficha guardada
                    </div>
                </div>

                <!-- CONTENIDO: PROGRESO -->
                <div id="sectionProgreso" style="display:none; padding: 20px 0;">
                    <div style="display: flex; flex-direction: column; gap: 30px;">
                        <!-- T1 -->
                        <div class="chart-container-box"
                            style="background: #f8fbff; border-radius: 12px; padding: 20px; border: 1px solid #eef2f7;">
                            <h4 style="margin-top: 0; color: #003366; display: flex; align-items: center; gap: 8px;">
                                <span>1Ô∏è‚É£</span> 1¬∫ Trimestre: Medias por √Årea
                            </h4>
                            <div style="height: 250px;">
                                <canvas id="chartT1"></canvas>
                            </div>
                        </div>

                        <!-- T2 -->
                        <div class="chart-container-box"
                            style="background: #f8fbff; border-radius: 12px; padding: 20px; border: 1px solid #eef2f7;">
                            <h4 style="margin-top: 0; color: #003366; display: flex; align-items: center; gap: 8px;">
                                <span>2Ô∏è‚É£</span> 2¬∫ Trimestre: Medias por √Årea
                            </h4>
                            <div style="height: 250px;">
                                <canvas id="chartT2"></canvas>
                            </div>
                        </div>

                        <!-- T3 -->
                        <div class="chart-container-box"
                            style="background: #f8fbff; border-radius: 12px; padding: 20px; border: 1px solid #eef2f7;">
                            <h4 style="margin-top: 0; color: #003366; display: flex; align-items: center; gap: 8px;">
                                <span>3Ô∏è‚É£</span> 3¬∫ Trimestre: Medias por √Årea
                            </h4>
                            <div style="height: 250px;">
                                <canvas id="chartT3"></canvas>
                            </div>
                        </div>
                    </div>
                    <p style="font-size: 0.85rem; color: #7f8c8d; margin-top: 15px; text-align: center;">
                        <em>* Los gr√°ficos muestran la media de cada asignatura basada en las calificaciones
                            registradas.</em>
                    </p>
                </div>
            </div>

        </div>

        <!-- MODAL NUEVO/EDITAR ALUMNO -->
        <div id="modalAlumno"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
            <div
                style="background:white; padding:25px; border-radius:12px; width:600px; max-width:95%; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow);">
                <h3 id="modalTitulo"
                    style="margin-top:0; color:var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px;">
                    Nuevo Alumno</h3>
                <input type="hidden" id="modalAlumnoId">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div style="grid-column: span 2;">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Nombre y Apellidos</label>
                        <input type="text" id="modalNombre" placeholder="Nombre completo"
                            style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing: border-box;">
                    </div>

                    <div>
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Fecha Nacimiento</label>
                        <input type="date" id="modalFechaNac"
                            style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Foto (Opcional)</label>
                        <input type="file" id="modalFotoFile" accept="image/*"
                            style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing: border-box; font-size: 0.8rem;">
                    </div>

                    <div style="grid-column: span 2;">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Direcci√≥n</label>
                        <input type="text" id="modalDireccion" placeholder="Calle, n√∫mero, piso..."
                            style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing: border-box;">
                    </div>

                    <div>
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Nombre Madre</label>
                        <input type="text" id="modalMadreNom"
                            style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Tel√©fono Madre</label>
                        <input type="text" id="modalMadreTel"
                            style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing: border-box;">
                    </div>
                    <div style="grid-column: span 2;">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Email Madre</label>
                        <input type="email" id="modalMadreEmail"
                            style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing: border-box;">
                    </div>

                    <div>
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Nombre Padre</label>
                        <input type="text" id="modalPadreNom"
                            style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Tel√©fono Padre</label>
                        <input type="text" id="modalPadreTel"
                            style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing: border-box;">
                    </div>
                    <div style="grid-column: span 2;">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Email Padre</label>
                        <input type="email" id="modalPadreEmail"
                            style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing: border-box;">
                    </div>

                    <div style="grid-column: span 2;">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Personas Autorizadas / Otras
                            Notas</label>
                        <textarea id="modalAutorizados" placeholder="Otras personas que pueden recoger al alumno..."
                            style="width:100%; height:60px; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing: border-box; font-family: inherit;"></textarea>
                    </div>

                    <div
                        style="grid-column: span 2; background:#f8f9fa; padding:15px; border-radius:8px; border: 1px solid #eef2f7;">
                        <label style="font-weight:bold; display:block; margin-bottom:10px;">üçΩÔ∏è D√≠as de Comedor:</label>
                        <div style="display:flex; justify-content: space-between; align-items: center;">
                            <div style="display:flex; gap:12px;">
                                <label><input type="checkbox" class="chk-dia" value="0"> Lun</label>
                                <label><input type="checkbox" class="chk-dia" value="1"> Mar</label>
                                <label><input type="checkbox" class="chk-dia" value="2"> Mi√©</label>
                                <label><input type="checkbox" class="chk-dia" value="3"> Jue</label>
                                <label><input type="checkbox" class="chk-dia" value="4"> Vie</label>
                            </div>
                            <div style="font-size:0.85em; color:#666;">
                                <a href="#" onclick="event.preventDefault(); toggleDias(true)"
                                    style="color:var(--primary); font-weight:600;">Todos</a> |
                                <a href="#" onclick="event.preventDefault(); toggleDias(false)"
                                    style="color:var(--danger); font-weight:600;">Ninguno</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    style="display:flex; justify-content:flex-end; gap:12px; margin-top:25px; border-top: 2px solid #eee; padding-top: 20px;">
                    <button onclick="cerrarModal()"
                        style="background:#f0f2f5; color:#666; border:none; border-radius:8px; font-weight:600; padding: 10px 20px;">Cancelar</button>
                    <button onclick="guardarAlumnoModal()"
                        style="background:var(--primary); color:white; border:none; border-radius:8px; font-weight:600; padding: 10px 25px; box-shadow: 0 4px 6px rgba(0,51,102,0.2);">
                        üíæ Guardar Alumno
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Transferir Alumno -->
        <div class="modal-overlay" id="transferModal">
            <div class="modal" style="max-width: 400px;">
                <h3 style="margin-top:0; color:var(--primary);">üîÑ Transferir Alumno</h3>
                <p>Mover a <strong id="transferNombreAlumno"></strong> al grupo:</p>
                <input type="hidden" id="transferAlumnoId">

                <select id="transferGroupSelect"
                    style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:1rem; margin-bottom: 20px;">
                    <option value="">Cargando grupos...</option>
                </select>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="document.getElementById('transferModal').style.display='none'"
                        style="background: #eef2f7; color: #333; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        Cancelar
                    </button>
                    <button onclick="ejecutarTransferencia()"
                        style="background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        Transferir
                    </button>
                </div>
            </div>
        </div>

        <script>
            let alumnoActual = null;

            /* ===== CARGAR LISTADO ===== */
            function cargarAlumnos() {
                fetch("/api/alumnos")
                    .then(r => r.json())
                    .then(alumnos => {
                        const lista = document.getElementById("listaAlumnos");
                        lista.innerHTML = "";

                        alumnos.forEach(a => {
                            const div = document.createElement("div");
                            div.className = "alumno-item";
                            if (alumnoActual == a.id) div.classList.add("activo");

                            // Contenedor principal flex
                            const content = document.createElement("div");
                            content.style.display = "flex";
                            content.style.justifyContent = "space-between";
                            content.style.alignItems = "center";

                            // Nombre (Clickable para seleccionar)
                            // Container de info principal (Foto + Nombre)
                            const divInfo = document.createElement("div");
                            divInfo.style.display = "flex";
                            divInfo.style.alignItems = "center";
                            divInfo.style.gap = "10px";
                            divInfo.style.flexGrow = "1";
                            divInfo.onclick = () => seleccionarAlumno(a.id, a.nombre, div); // Mover el click aqu√≠

                            // Checkbox
                            const cb = document.createElement("input");
                            cb.type = "checkbox";
                            cb.className = "alumno-checkbox";
                            cb.value = a.id;
                            cb.dataset.nombre = a.nombre;
                            cb.style.transform = "scale(1.2)";
                            cb.onclick = (e) => {
                                e.stopPropagation();
                                updateBatchButtons();
                            };

                            // Foto
                            const img = document.createElement("img");
                            img.style.width = "40px";
                            img.style.height = "40px";
                            img.style.borderRadius = "50%";
                            img.style.objectFit = "cover";
                            img.style.border = "1px solid #ddd";
                            if (a.foto) {
                                img.src = "/static/uploads/" + a.foto;
                            } else {
                                // Placeholder emoji o imagen por defecto
                                img.src = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%23ccc'><circle cx='50' cy='50' r='50'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>üë§</text></svg>";
                            }

                            const spanNombre = document.createElement("span");
                            spanNombre.innerText = a.nombre;

                            divInfo.appendChild(cb);
                            divInfo.appendChild(img);
                            divInfo.appendChild(spanNombre);

                            // Botones acciones
                            const divAcciones = document.createElement("div");
                            divAcciones.style.display = "flex";
                            divAcciones.style.gap = "5px";

                            // Bot√≥n Editar
                            const btnEdit = document.createElement("button");
                            btnEdit.innerHTML = "‚úèÔ∏è";
                            btnEdit.title = "Editar nombre/comedor";
                            btnEdit.style.padding = "2px 6px";
                            btnEdit.style.background = "none";
                            btnEdit.style.border = "none";
                            btnEdit.style.fontSize = "1.1em";
                            btnEdit.onclick = (e) => {
                                e.stopPropagation();
                                mostrarModalEditar(a);
                            };

                            // Bot√≥n Ver Perfil
                            const btnView = document.createElement("button");
                            btnView.innerHTML = "üëÄ";
                            btnView.title = "Ver Expediente Completo";
                            btnView.style.padding = "2px 6px";
                            btnView.style.background = "none";
                            btnView.style.border = "none";
                            btnView.style.fontSize = "1.1em";
                            btnView.onclick = (e) => {
                                e.stopPropagation();
                                window.location.href = `/perfil/${a.id}`;
                            };

                            // Bot√≥n Borrar
                            const btnDel = document.createElement("button");
                            btnDel.innerHTML = "üóëÔ∏è";
                            btnDel.title = "Borrar alumno";
                            btnDel.style.padding = "2px 6px";
                            btnDel.style.background = "none";
                            btnDel.style.border = "none";
                            btnDel.style.fontSize = "1.1em";
                            btnDel.onclick = (e) => {
                                e.stopPropagation();
                                borrarAlumno(a.id, a.nombre);
                            };

                            // Bot√≥n Transferir
                            const btnTransfer = document.createElement("button");
                            btnTransfer.innerHTML = "üîÑ";
                            btnTransfer.title = "Transferir a otro grupo";
                            btnTransfer.style.padding = "2px 6px";
                            btnTransfer.style.background = "none";
                            btnTransfer.style.border = "none";
                            btnTransfer.style.fontSize = "1.1em";
                            btnTransfer.onclick = (e) => {
                                e.stopPropagation();
                                abrirModalTransferir(a.id, a.nombre);
                            };

                            divAcciones.appendChild(btnView);
                            divAcciones.appendChild(btnEdit);
                            divAcciones.appendChild(btnTransfer);
                            divAcciones.appendChild(btnDel);

                            content.appendChild(divInfo); // Cambio: info completa (foto+nombre)
                            content.appendChild(divAcciones);

                            div.appendChild(content);
                            lista.appendChild(div);
                        });
                    });
            }

            // Inicio
            cargarAlumnos();

            function seleccionarAlumno(id, nombre, div) {
                alumnoActual = id;

                document.querySelectorAll(".alumno-item").forEach(e =>
                    e.classList.remove("activo")
                );
                div.classList.add("activo");

                document.getElementById("nombreAlumno").innerText = nombre;

                fetch(`/api/alumnos/ficha/${id}`)
                    .then(r => r.json())
                    .then(d => {
                        document.getElementById("fecha_nacimiento").value = d.fecha_nacimiento || "";
                        document.getElementById("direccion").value = d.direccion || "";
                        document.getElementById("madre_nombre").value = d.madre_nombre || "";
                        document.getElementById("madre_telefono").value = d.madre_telefono || "";
                        document.getElementById("madre_email").value = d.madre_email || "";
                        document.getElementById("padre_nombre").value = d.padre_nombre || "";
                        document.getElementById("padre_telefono").value = d.padre_telefono || "";
                        document.getElementById("padre_email").value = d.padre_email || "";
                        document.getElementById("observaciones_generales").value = d.observaciones_generales || "";
                        document.getElementById("personas_autorizadas").value = d.personas_autorizadas || "";
                    });

                // Si estamos en la pesta√±a de progreso, cargar el gr√°fico
                if (document.getElementById("sectionProgreso").style.display === "block") {
                    renderProgressChart(id);
                }
            }

            /* ===== TABS DE PERFIL ===== */
            function changeProfileTab(tab) {
                const sectionDatos = document.getElementById("sectionDatos");
                const sectionProgreso = document.getElementById("sectionProgreso");
                const btnDatos = document.getElementById("btnTabDatos");
                const btnProgreso = document.getElementById("btnTabProgreso");

                if (tab === 'datos') {
                    sectionDatos.style.display = "block";
                    sectionProgreso.style.display = "none";
                    btnDatos.style.borderColor = "#003366";
                    btnDatos.style.color = "#003366";
                    btnProgreso.style.borderColor = "transparent";
                    btnProgreso.style.color = "#666";
                } else {
                    sectionDatos.style.display = "none";
                    sectionProgreso.style.display = "block";
                    btnProgreso.style.borderColor = "#003366";
                    btnProgreso.style.color = "#003366";
                    btnDatos.style.borderColor = "transparent";
                    btnDatos.style.color = "#666";
                    if (alumnoActual) renderProgressChart(alumnoActual);
                }
            }

            let charts = { T1: null, T2: null, T3: null };

            function renderProgressChart(id) {
                fetch(`/api/alumnos/progreso/${id}`)
                    .then(r => r.json())
                    .then(datos => {
                        createTrimesterChart('chartT1', datos["1"], 'T1', '#007bff');
                        createTrimesterChart('chartT2', datos["2"], 'T2', '#28a745');
                        createTrimesterChart('chartT3', datos["3"], 'T3', '#ffc107');
                    });
            }

            function createTrimesterChart(canvasId, items, chartKey, color) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                if (charts[chartKey]) charts[chartKey].destroy();

                // Si no hay datos, mostrar placeholder o limpiar
                if (!items || items.length === 0) {
                    // Podr√≠amos pintar algo opcional, por ahora vaciamos
                    return;
                }

                charts[chartKey] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: items.map(i => i.area),
                        datasets: [{
                            label: 'Media',
                            data: items.map(i => i.media),
                            backgroundColor: color,
                            borderRadius: 6,
                            barThickness: 30
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10,
                                grid: { color: '#f0f0f0' },
                                ticks: { font: { weight: 'bold' } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: {
                                    font: { weight: 'bold', size: 11 },
                                    autoSkip: false,
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#003366',
                                padding: 10,
                                displayColors: false,
                                callbacks: {
                                    label: (context) => `Nota Media: ${context.parsed.y}`
                                }
                            }
                        }
                    }
                });
            }

            /* ===== GUARDAR FICHA ===== */
            function guardarFicha() {
                if (!alumnoActual) return;

                fetch("/api/alumnos/ficha", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        alumno_id: alumnoActual,
                        fecha_nacimiento: document.getElementById("fecha_nacimiento").value,
                        direccion: document.getElementById("direccion").value,
                        madre_nombre: document.getElementById("madre_nombre").value,
                        madre_telefono: document.getElementById("madre_telefono").value,
                        madre_email: document.getElementById("madre_email").value,
                        padre_nombre: document.getElementById("padre_nombre").value,
                        padre_telefono: document.getElementById("padre_telefono").value,
                        padre_email: document.getElementById("padre_email").value,
                        observaciones_generales: document.getElementById("observaciones_generales").value,
                        personas_autorizadas: document.getElementById("personas_autorizadas").value
                    })
                }).then(() => {
                    const msg = document.getElementById("mensajeGuardado");
                    msg.style.display = "block";

                    setTimeout(() => {
                        msg.style.display = "none";
                    }, 1500);
                });
            }


            /* ===== LIMPIAR FICHA===== */
            function limpiarFicha() {
                if (!alumnoActual) return;

                fetch(`/api/alumnos/ficha/${alumnoActual}`, {
                    method: "DELETE"
                }).then(() => {
                    document.getElementById("fecha_nacimiento").value = "";
                    document.getElementById("direccion").value = "";
                    document.getElementById("madre_nombre").value = "";
                    document.getElementById("madre_telefono").value = "";
                    document.getElementById("madre_email").value = "";
                    document.getElementById("padre_nombre").value = "";
                    document.getElementById("padre_telefono").value = "";
                    document.getElementById("padre_email").value = "";
                    document.getElementById("observaciones_generales").value = "";
                    document.getElementById("personas_autorizadas").value = "";
                });
            }

            /* ===== GESTI√ìN DE ALUMNOS (MODAL) ===== */
            const modal = document.getElementById("modalAlumno");
            const modalTitulo = document.getElementById("modalTitulo");
            const modalId = document.getElementById("modalAlumnoId");
            const modalNombre = document.getElementById("modalNombre");
            // const modalNoComedor = document.getElementById("modalNoComedor"); // Removed

            function toggleDias(check) {
                document.querySelectorAll(".chk-dia").forEach(c => c.checked = check);
            }

            function mostrarModalNuevo() {
                modalTitulo.innerText = "Nuevo Alumno";
                modalId.value = "";
                modalNombre.value = "";
                document.getElementById("modalFechaNac").value = "";
                document.getElementById("modalDireccion").value = "";
                document.getElementById("modalMadreNom").value = "";
                document.getElementById("modalMadreTel").value = "";
                document.getElementById("modalMadreEmail").value = "";
                document.getElementById("modalPadreNom").value = "";
                document.getElementById("modalPadreTel").value = "";
                document.getElementById("modalPadreEmail").value = "";
                document.getElementById("modalAutorizados").value = "";
                document.getElementById("modalFotoFile").value = "";
                toggleDias(true);
                modal.style.display = "flex";
                document.body.style.overflow = "hidden";
                modalNombre.focus();
            }

            async function mostrarModalEditar(alumno) {
                modalTitulo.innerText = "Editar Alumno";
                modalId.value = alumno.id;
                modalNombre.value = alumno.nombre;
                document.getElementById("modalFotoFile").value = "";

                // Cargar datos adicionales de la ficha
                try {
                    const r = await fetch(`/api/alumnos/ficha/${alumno.id}`);
                    const d = await r.json();
                    document.getElementById("modalFechaNac").value = d.fecha_nacimiento || "";
                    document.getElementById("modalDireccion").value = d.direccion || "";
                    document.getElementById("modalMadreNom").value = d.madre_nombre || "";
                    document.getElementById("modalMadreTel").value = d.madre_telefono || "";
                    document.getElementById("modalMadreEmail").value = d.madre_email || "";
                    document.getElementById("modalPadreNom").value = d.padre_nombre || "";
                    document.getElementById("modalPadreTel").value = d.padre_telefono || "";
                    document.getElementById("modalPadreEmail").value = d.padre_email || "";
                    document.getElementById("modalAutorizados").value = d.personas_autorizadas || "";
                } catch (e) {
                    console.error("Error al cargar ficha para editar", e);
                }

                if (alumno.comedor_dias) {
                    const dias = alumno.comedor_dias.split(",");
                    document.querySelectorAll(".chk-dia").forEach(c => {
                        c.checked = dias.includes(c.value);
                    });
                } else {
                    const come = (alumno.no_comedor === 0);
                    toggleDias(come);
                }

                modal.style.display = "flex";
                document.body.style.overflow = "hidden";
                modalNombre.focus();
            }

            function cerrarModal() {
                modal.style.display = "none";
                document.body.style.overflow = "";
            }

            async function deleteActiveGroup() {
                const globalSelect = document.getElementById('globalGroupSelect');
                const groupId = globalSelect.value;
                const groupName = globalSelect.options[globalSelect.selectedIndex].text;

                if (!groupId) {
                    alert("No hay ning√∫n grupo seleccionado para eliminar.");
                    return;
                }

                if (!confirm("¬øEst√°s 100% seguro de que quieres eliminar el grupo '" + groupName + "'? ¬°Esta acci√≥n borrar√° el grupo para siempre! (Solo se puede borrar si no contiene alumnos)")) {
                    return;
                }

                try {
                    const res = await fetch('/api/grupos/' + groupId, {
                        method: 'DELETE'
                    });

                    const data = await res.json();
                    if (data.ok) {
                        alert("üóëÔ∏è Grupo eliminado con √©xito.");
                        window.location.href = "/";
                    } else {
                        alert("Error: " + data.error);
                    }
                } catch (err) {
                    alert("Error de conexi√≥n al eliminar el grupo.");
                    console.error(err);
                }
            }

            function guardarAlumnoModal() {
                const nombre = modalNombre.value.trim();

                // Get selected days
                const diasSeleccionados = Array.from(document.querySelectorAll(".chk-dia:checked"))
                    .map(c => c.value);

                // Logic compatible with DB:
                // comedor_dias = "0,1,2..."
                // no_comedor = 1 if list is empty, 0 otherwise (legacy fallback)

                const comedor_dias = diasSeleccionados.join(",");
                const no_comedor = (diasSeleccionados.length > 0) ? 0 : 1;

                if (!nombre) {
                    alert("El nombre no puede estar vac√≠o");
                    return;
                }

                // 1. Guardar datos b√°sicos
                const id = modalId.value;
                const url = id ? `/api/alumnos/${id}` : "/api/alumnos/nuevo";
                const method = id ? "PUT" : "POST";

                const payload = {
                    nombre,
                    no_comedor,
                    comedor_dias,
                    fecha_nacimiento: document.getElementById("modalFechaNac").value,
                    direccion: document.getElementById("modalDireccion").value,
                    madre_nombre: document.getElementById("modalMadreNom").value,
                    madre_telefono: document.getElementById("modalMadreTel").value,
                    madre_email: document.getElementById("modalMadreEmail").value,
                    padre_nombre: document.getElementById("modalPadreNom").value,
                    padre_telefono: document.getElementById("modalPadreTel").value,
                    padre_email: document.getElementById("modalPadreEmail").value,
                    personas_autorizadas: document.getElementById("modalAutorizados").value
                };

                fetch(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                })
                    .then(r => r.json())
                    .then(res => {
                        if (res.ok) {
                            // 2. Si hay foto nueva, subirla
                            const fileInput = document.getElementById("modalFotoFile");
                            const newId = id || res.id; // Si era nuevo, usamos el ID devuelto

                            if (fileInput.files.length > 0) {
                                const formData = new FormData();
                                formData.append("foto", fileInput.files[0]);

                                fetch(`/api/alumnos/${newId}/foto`, {
                                    method: 'POST',
                                    body: formData
                                })
                                    .then(r => r.json())
                                    .then(uploadRes => {
                                        if (uploadRes.ok) {
                                            cerrarModal();
                                            cargarAlumnos();
                                            if (id && alumnoActual == id) { // Update header if same student
                                                document.getElementById("nombreAlumno").innerText = nombre;
                                                // Update profile pic in header if we had one (optional)
                                            }
                                        } else {
                                            alert("Datos guardados, pero error al subir foto: " + uploadRes.error);
                                            cerrarModal();
                                            cargarAlumnos();
                                        }
                                    });
                            } else {
                                // Sin foto nueva
                                cerrarModal();
                                cargarAlumnos();
                                if (id && alumnoActual == id) {
                                    document.getElementById("nombreAlumno").innerText = nombre;
                                }
                            }
                        } else {
                            alert("Error al guardar: " + res.error);
                        }
                    })
                    .catch(err => alert("Error de red: " + err));
            }

            function borrarAlumno(id, nombre) {
                if (!confirm(`¬øEst√°s SEGURO de que quieres borrar a ${nombre}?\n\n‚ö†Ô∏è ESTA ACCI√ìN BORRAR√Å TODOS SUS DATOS (Notas, Asistencia, etc) Y NO SE PUEDE DESHACER.`)) {
                    return;
                }

                fetch(`/api/alumnos/${id}`, {
                    method: "DELETE"
                })
                    .then(r => r.json())
                    .then(res => {
                        if (res.ok) {
                            if (alumnoActual == id) {
                                alumnoActual = null;
                                document.getElementById("nombreAlumno").innerText = "Selecciona un alumno";
                                limpiarFichaUI();
                            }
                            cargarAlumnos();
                        } else {
                            alert("Error al borrar: " + res.error);
                        }
                    });
            }

            async function abrirModalTransferir(id, nombre) {
                document.getElementById('transferAlumnoId').value = id;
                document.getElementById('transferNombreAlumno').innerText = nombre;

                // Fetch groups
                try {
                    const res = await fetch('/api/grupos');
                    const groups = await res.json();
                    const select = document.getElementById('transferGroupSelect');

                    const activeGroupId = document.getElementById('globalGroupSelect').value;

                    if (groups.length <= 1) {
                        alert("No tienes otros grupos a los que transferir este alumno (solo existe 1 grupo actualmente).");
                        return;
                    }

                    const filtered = groups.filter(g => g.id.toString() !== activeGroupId.toString());
                    if (filtered.length === 0) {
                        alert("No hay otros grupos disponibles (el alumno ya est√° en el √∫nico grupo que existe).");
                        return;
                    }

                    select.innerHTML = filtered.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');

                    document.getElementById('transferModal').style.display = 'flex';
                } catch (e) {
                    alert("Error cargando la lista de grupos: " + e.message);
                    console.error("Error cargando grupos", e);
                }
            }

            async function ejecutarTransferencia() {
                const alumnoId = document.getElementById('transferAlumnoId').value;
                const nuevoGrupoId = document.getElementById('transferGroupSelect').value;

                if (!nuevoGrupoId || !alumnoId) return;

                const ids = alumnoId.split(',');
                let successCount = 0;
                let errorCount = 0;

                for (let id of ids) {
                    try {
                        const res = await fetch(`/api/alumnos/${id}/transferir`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ nuevo_grupo_id: nuevoGrupoId })
                        });

                        const text = await res.text();
                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch (e) {
                            console.error("Error del servidor (no JSON): " + text.slice(0, 100));
                            errorCount++;
                            continue;
                        }

                        if (data.ok) {
                            successCount++;
                        } else {
                            console.error("Error del servidor: " + (data.error || "Desconocido"));
                            errorCount++;
                        }
                    } catch (e) {
                        console.error("Excepci√≥n de red al transferir alumno: " + e.message);
                        errorCount++;
                    }
                }

                document.getElementById('transferModal').style.display = 'none';

                if (ids.length > 1) {
                    alert(`Transferencia completada.\n‚úÖ Transferidos: ${successCount}\n‚ùå Errores: ${errorCount}`);
                } else if (errorCount > 0) {
                    alert('Error al transferir al alumno. Revisa la consola para m√°s detalles.');
                }

                // Limpieza de UI
                const chkAll = document.getElementById('selectAllCheckbox');
                if (chkAll) chkAll.checked = false;
                if (typeof updateBatchButtons === 'function') updateBatchButtons();

                cargarAlumnos();
                limpiarFichaUI();
                document.getElementById("nombreAlumno").innerText = "Selecciona un alumno";
                alumnoActual = null;
            }

            function limpiarFichaUI() {
                document.getElementById("fecha_nacimiento").value = "";
                document.getElementById("direccion").value = "";
                document.getElementById("madre_nombre").value = "";
                document.getElementById("madre_telefono").value = "";
                document.getElementById("madre_email").value = "";
                document.getElementById("padre_nombre").value = "";
                document.getElementById("padre_telefono").value = "";
                document.getElementById("padre_email").value = "";
                document.getElementById("observaciones_generales").value = "";
                document.getElementById("personas_autorizadas").value = "";
                if (charts.T1) charts.T1.destroy();
                if (charts.T2) charts.T2.destroy();
                if (charts.T3) charts.T3.destroy();
            }

            function exportarData(tipo) {
                window.location.href = `/api/alumnos/exportar/${tipo}`;
            }
            function descargarPlantilla() {
                window.location.href = "/api/alumnos/plantilla";
            }

            async function importarCSV(input) {
                if (!input.files || input.files.length === 0) return;

                const file = input.files[0];
                const formData = new FormData();
                formData.append("file", file);

                try {
                    const response = await fetch("/api/alumnos/importar", {
                        method: "POST",
                        body: formData
                    });
                    const res = await response.json();

                    if (res.ok) {
                        alert(`¬°√âxito! Se han importado ${res.count} alumnos.`);
                        cargarAlumnos();
                    } else {
                        alert("Error al importar: " + res.error);
                    }
                } catch (error) {
                    alert("Error de red al importar CSV.");
                }

                input.value = ""; // Limpiar el input
            }

            // --- BATCH ACTIONS LOGIC ---
            function toggleSelectAll(el) {
                const checkboxes = document.querySelectorAll('.alumno-checkbox');
                checkboxes.forEach(cb => cb.checked = el.checked);
                updateBatchButtons();
            }

            function updateBatchButtons() {
                const checked = document.querySelectorAll('.alumno-checkbox:checked');
                const btnT = document.getElementById('btnBatchTransfer');
                const btnD = document.getElementById('btnBatchDelete');

                if (checked.length > 0) {
                    btnT.style.display = 'inline-block';
                    btnD.style.display = 'inline-block';
                } else {
                    btnT.style.display = 'none';
                    btnD.style.display = 'none';
                    document.getElementById('selectAllCheckbox').checked = false;
                }
            }

            async function batchDelete() {
                const checked = Array.from(document.querySelectorAll('.alumno-checkbox:checked'));
                if (checked.length === 0) return;

                if (!confirm(`¬øEst√°s SEGURO de que quieres borrar a los ${checked.length} alumnos seleccionados?\n\nEsta acci√≥n los archivar√°.`)) return;

                let successCount = 0;
                let errorCount = 0;

                for (const cb of checked) {
                    try {
                        const res = await fetch(`/api/alumnos/${cb.value}`, { method: "DELETE" });
                        const dat = await res.json();
                        if (dat.ok) successCount++;
                        else errorCount++;
                    } catch (e) {
                        errorCount++;
                    }
                }

                alert(`Proceso completado.\n‚úÖ Borrados: ${successCount}\n‚ùå Errores: ${errorCount}`);
                document.getElementById('selectAllCheckbox').checked = false;
                updateBatchButtons();
                cargarAlumnos();
                if (alumnoActual && checked.some(c => c.value == alumnoActual)) {
                    alumnoActual = null;
                    document.getElementById("nombreAlumno").innerText = "Selecciona un alumno";
                    limpiarFichaUI();
                }
            }

            async function batchTransfer() {
                const checked = Array.from(document.querySelectorAll('.alumno-checkbox:checked'));
                if (checked.length === 0) return;

                // We reuse the transfer modal, but pass multiple IDs
                const ids = checked.map(c => c.value).join(',');
                const label = `los ${checked.length} alumnos seleccionados`;
                abrirModalTransferir(ids, label);
            }

        </script>
</body>

</html>